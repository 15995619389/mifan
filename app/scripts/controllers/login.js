// Generated by CoffeeScript 1.7.1
"use strict";
Mifan.controller("loginCtrl", function($scope, $http, $cookieStore, $timeout) {
  var API, IsDebug, LOC, userLogin, userLoginErrorCb, userLoginSuccessCb;
  API = $scope.API;
  IsDebug = $scope.IsDebug;
  LOC = $scope.LOC;
  $scope.error = null;
  userLoginSuccessCb = function(data, status) {

    /*
    {
      "msg": "密码错误！",
      "ret": "104003"
    }
    
    {
      "msg": "Email不存在，你可能还没有注册！",
      "ret": "104002"
    }
    
    {
      "msg": "OK",
      "ret": "100000",
      "result": {}
    }
     */
    var result, ret;
    ret = data["ret"];
    if (ret === "100000") {
      result = data["result"];
      $scope.user.username = result["user"]["username"] || "";
      $scope.user.email = result["user"]["email"] || "";
      $scope.user.face = result["user"]["face"] || "";
      $scope.user.sex = result["user"]["sex"] || "1cookieStore";
      $scope.user.blog = result["user"]["blog"] || "";
      $cookieStore.put("MifanUser", JSON.stringify($scope.user));
      LOC["href"] = "#!/";
      return $scope.isLoging = false;
    }
  };
  userLoginErrorCb = function(data, status) {
    var ret;
    ret = data["ret"];
    if (ret === "104003") {
      $scope.error = {
        type: "password",
        msg: "密码错误 :("
      };
    } else if (ret === "104002") {
      $scope.error = {
        type: "username",
        msg: "用户名不存在 T_T"
      };
    }
    if ($scope.error) {
      $timeout(function() {
        return $scope.error = null;
      }, 3000);
    }
    return $scope.isLoging = false;
  };
  userLogin = function() {
    $scope.isLoging = true;
    return $http({
      method: IsDebug ? "GET" : "POST",
      url: API.user,
      data: {
        user_email: $scope.email,
        user_password: $scope.password
      }
    }).success(userLoginSuccessCb).error(userLoginErrorCb);
  };
  $scope.$on("$viewContentLoaded", function() {
    return $scope.$emit("pageChange", "login");
  });
  $scope.$watch("email + password", function() {
    return $scope.isLogValid = $scope.email && $scope.password;
  });
  $scope.isLoging = false;
  return $scope.onSubmit = function() {
    if ($scope.email && $scope.password) {
      return userLogin();
    }
  };
});
