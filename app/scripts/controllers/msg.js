// Generated by CoffeeScript 1.7.1
"use strict";
Mifan.controller("msgCtrl", function($scope, $rootScope, $http, $debug, $timeout) {
  var DOC, ans, msg;
  DOC = $scope.DOC;
  $scope.$on("$viewContentLoaded", function() {
    return $scope.$emit("pageChange", "msg");
  });
  $scope.expander = function(target) {};
  $scope.setMBill = function(index) {
    return $scope.toggleMBill(["love", "answer", "share"]);
  };
  msg = {
    init: function() {
      msg.getAskMe();
      $scope.askMe = [];
      $scope.askMeMsg = "";
      return $scope.askMeMore = false;
    },
    getAskMe: function() {
      var api;
      api = "" + API.askme + $scope.privacyParamDir + "/type/askme";
      if (IsDebug) {
        api = API.askme;
      }
      return $http.get(api).success(msg.getAskMeCb);
    },
    getAskMeCb: function(data) {
      if (String(data.msg) === "ok") {
        $scope.askMe = data.result || [];
        return msg.count = data.result.length;
      } else {
        return $scope.askMeMsg = data.msg;
      }
    },
    count: 0
  };
  msg.init();
  ans = {
    init: function() {
      $scope.send = ans.send;
      return $scope.$watch($scope.askMe, function() {
        if ($scope.askMe.length === 0) {
          return $scope.askMeMsg = "ç©º";
        }
      });
    },
    send: function(item, msg) {
      var api, query;
      item.isSending = true;
      api = "" + API.answer + $scope.privacyParamDir;
      if (IsDebug) {
        api = API.answer;
      }
      query = {
        askid: msg.askid,
        content: item.content
      };
      return (IsDebug ? $http.get : $http.post)(api, query).success(function(data) {
        return ans.sendCb.call(item, data);
      });
    },
    sendCb: function(data) {
      this.content = "";
      this.isSending = false;
      $scope.toast(data.msg);
      if (String(data.ret) === "100000") {
        $timeout(((function(_this) {
          return function() {
            _this.isSendSucs = true;
            _this.answerd = true;
            return _this.isSendSucs = false;
          };
        })(this)), 1000);
        ans.count++;
        if (ans.count >= msg.count) {
          return $scope.askMe.length = 0;
        }
      }
    },
    count: 0
  };
  ans.init();
  return false;
});
